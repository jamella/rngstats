#! /bin/sh

output="$1"; shift
scratch=$(tempfile -d $(dirname "$output") -p ct_ -s .c)
trap "rm -f '$scratch'" 0

ciphers=$(sed -ne 's/^DEFINE_CIPHER(\([a-zA-Z0-9_]*\),.*$/\1/p' "$@" |
          LC_COLLATE=C sort)
(
printf '%s\n\n%s\n\n' \
  '/* This file was generated by gen-ciphertab. DO NOT EDIT. */' \
  '#include "ciphers.h"'

for cipher in $ciphers; do
    case $cipher in
        # aes128_cipher is already declared in ciphers.h.
        (aes128) ;;
        (*) printf 'extern const cipher %s_cipher;\n' $cipher ;;
    esac
done
printf '\nconst cipher *all_ciphers[] = {\n'
for cipher in $ciphers; do
    printf '  &%s_cipher,\n' $cipher
done
printf '  0,\n};\n'

) > "$scratch"

mv -f "$scratch" "$output"
trap "" 0
